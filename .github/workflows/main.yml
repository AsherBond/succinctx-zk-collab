name: "Main"
on:
  push:
    branches:
      - main

jobs:
  test:
      name: Expensive Test Suite
      runs-on: chad
      steps:
        - name: Checkout sources
          uses: actions/checkout@v2

        - name: Install nightly toolchain
          id: rustc-toolchain
          uses: actions-rs/toolchain@v1
          with:
            profile: minimal
            toolchain: nightly-2023-08-24
            override: true

        - name: rust-cache
          uses: actions/cache@v3
          with:
            path: |
              ~/.cargo/bin/
              ~/.cargo/registry/index/
              ~/.cargo/registry/cache/
              ~/.cargo/git/db/
              target/
            key: rustc-test-${{ steps.rustc-toolchain.outputs.rustc_hash }}-cargo-${{ hashFiles('**/Cargo.toml') }}

        - name: Check in plonky2x subdirectory
          uses: actions-rs/cargo@v1
          with:
            command: check
            args: --manifest-path plonky2x/Cargo.toml
          env:
            RUSTFLAGS: -Copt-level=3 -Cdebug-assertions -Coverflow-checks=y -Cdebuginfo=0
            RUST_LOG: 1
            CARGO_INCREMENTAL: 1
            RUST_BACKTRACE: 1

        - name: Run cargo test
          uses: actions-rs/cargo@v1
          with:
            command: test
            args: --workspace
          env:
            RUSTFLAGS: -Copt-level=3 -Cdebug-assertions -Coverflow-checks=y -Cdebuginfo=0
            RUST_LOG: 1
            CARGO_INCREMENTAL: 1
            RUST_BACKTRACE: 1